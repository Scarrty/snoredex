// SPDX-License-Identifier: CC-BY-NC-4.0
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InventoryMovementType {
  purchase
  sale
  transfer_in
  transfer_out
  adjustment
}

enum ExternalListingStatus {
  draft
  active
  paused
  sold
  ended
  error
}

model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique @db.VarChar(100)
  email       String?  @unique @db.VarChar(255)
  displayName String?  @map("display_name") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  inventoryItems InventoryItem[]

  @@map("users")
}

model Pokemon {
  id            Int      @id @default(autoincrement())
  name          String   @unique @db.VarChar(100)
  nationalDexNo Int?     @unique @map("national_dex_no")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  cardPrints CardPrint[]

  @@map("pokemon")
}

model Era {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  sets Set[]

  @@map("eras")
}

model Set {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  setCode   String?  @map("set_code") @db.VarChar(20)
  eraId     Int?     @map("era_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  era        Era?        @relation(fields: [eraId], references: [id])
  cardPrints CardPrint[]

  @@unique([name, setCode])
  @@map("sets")
}

model CardType {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  cardPrints CardPrint[]

  @@map("card_types")
}

model CardPrint {
  id         Int      @id @default(autoincrement())
  pokemonId  Int      @map("pokemon_id")
  setId      Int      @map("set_id")
  cardNumber String   @map("card_number") @db.VarChar(50)
  typeId     Int?     @map("type_id")
  sortNumber Int?     @map("sort_number")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  pokemon Pokemon   @relation(fields: [pokemonId], references: [id])
  set     Set       @relation(fields: [setId], references: [id])
  type    CardType? @relation(fields: [typeId], references: [id])

  inventoryItems     InventoryItem[]
  cardPrintLanguages CardPrintLanguage[]

  @@map("card_prints")
}

model Language {
  id        Int      @id @default(autoincrement())
  code      String   @unique @db.VarChar(20)
  name      String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  cardPrintLanguages CardPrintLanguage[]
  acquisitionLines   AcquisitionLine[]
  salesLines         SalesLine[]

  @@map("languages")
}

model CardPrintLanguage {
  cardPrintId Int @map("card_print_id")
  languageId  Int @map("language_id")

  cardPrint CardPrint @relation(fields: [cardPrintId], references: [id], onDelete: Cascade)
  language  Language  @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@id([cardPrintId, languageId])
  @@map("card_print_languages")
}

model Location {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(255)
  locationType String   @map("location_type") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  inventoryItems InventoryItem[]

  @@map("locations")
}

model CardCondition {
  id        Int      @id @default(autoincrement())
  code      String   @unique @db.VarChar(20)
  name      String   @db.VarChar(100)
  sortOrder Int      @unique @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  inventoryItems InventoryItem[]

  @@map("card_conditions")
}

model InventoryItem {
  id               Int      @id @default(autoincrement())
  cardPrintId      Int      @map("card_print_id")
  userId           Int      @map("user_id")
  locationId       Int      @map("location_id")
  conditionId      Int      @map("condition_id")
  gradeProvider    String?  @map("grade_provider") @db.VarChar(100)
  gradeValue       Decimal? @map("grade_value") @db.Decimal(3, 1)
  quantityOnHand   Int      @default(1) @map("quantity_on_hand")
  quantityReserved Int      @default(0) @map("quantity_reserved")
  quantityDamaged  Int      @default(0) @map("quantity_damaged")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  cardPrint  CardPrint     @relation(fields: [cardPrintId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id])
  location   Location      @relation(fields: [locationId], references: [id])
  condition  CardCondition @relation(fields: [conditionId], references: [id])
  inventoryMovements InventoryMovement[]
  externalListings   ExternalListing[]
  acquisitionLines   AcquisitionLine[]
  salesLines         SalesLine[]

  @@map("inventory_items")
}

model InventoryMovement {
  id            Int                   @id @default(autoincrement())
  inventoryItemId Int                 @map("inventory_item_id")
  movementType  InventoryMovementType @map("movement_type")
  quantityDelta Int                   @map("quantity_delta")
  occurredAt    DateTime              @default(now()) @map("occurred_at") @db.Timestamptz(6)
  referenceType String?               @map("reference_type") @db.VarChar(100)
  referenceId   String?               @map("reference_id") @db.VarChar(100)
  notes         String?
  createdBy     String?               @map("created_by") @db.VarChar(100)
  createdAt     DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime              @default(now()) @map("updated_at") @db.Timestamptz(6)

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId, occurredAt], map: "idx_inventory_movements_item_occurred_at")
  @@index([movementType, occurredAt], map: "idx_inventory_movements_type_occurred_at")
  @@map("inventory_movements")
}

model Marketplace {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  slug      String   @unique @db.VarChar(50)
  baseUrl   String?  @map("base_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  externalListings ExternalListing[]

  @@map("marketplaces")
}

model ExternalListing {
  id                Int                   @id @default(autoincrement())
  marketplaceId     Int                   @map("marketplace_id")
  inventoryItemId   Int                   @map("inventory_item_id")
  externalListingId String                @map("external_listing_id") @db.VarChar(255)
  listingStatus     ExternalListingStatus @default(active) @map("listing_status")
  listedPrice       Decimal?              @map("listed_price") @db.Decimal(12, 2)
  currency          String?               @db.Char(3)
  quantityListed    Int?                  @map("quantity_listed")
  syncedAt          DateTime?             @map("synced_at") @db.Timestamptz(6)
  url               String?
  createdAt         DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime              @default(now()) @map("updated_at") @db.Timestamptz(6)

  marketplace   Marketplace   @relation(fields: [marketplaceId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([marketplaceId, externalListingId], map: "uq_external_listings_marketplace_listing_id")
  @@index([marketplaceId], map: "idx_external_listings_marketplace_id")
  @@index([inventoryItemId], map: "idx_external_listings_inventory_item")
  @@index([listingStatus], map: "idx_external_listings_status")
  @@map("external_listings")
}

model Acquisition {
  id                Int      @id @default(autoincrement())
  acquiredAt        DateTime @map("acquired_at") @db.Date
  supplierReference String?  @map("supplier_reference") @db.VarChar(255)
  channel           String?  @db.VarChar(100)
  currency          String   @db.Char(3)
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  lines AcquisitionLine[]

  @@map("acquisitions")
}

model AcquisitionLine {
  id              Int      @id @default(autoincrement())
  acquisitionId   Int      @map("acquisition_id")
  inventoryItemId Int      @map("inventory_item_id")
  languageId      Int?     @map("language_id")
  quantity        Int
  unitCost        Decimal  @map("unit_cost") @db.Decimal(12, 2)
  fees            Decimal  @default(0) @db.Decimal(12, 2)
  shipping        Decimal  @default(0) @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  acquisition   Acquisition   @relation(fields: [acquisitionId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  language      Language?     @relation(fields: [languageId], references: [id])

  @@index([acquisitionId], map: "idx_acquisition_lines_acquisition_id")
  @@index([inventoryItemId], map: "idx_acquisition_lines_inventory")
  @@map("acquisition_lines")
}

model Sale {
  id             Int      @id @default(autoincrement())
  soldAt         DateTime @map("sold_at") @db.Date
  buyerReference String?  @map("buyer_reference") @db.VarChar(255)
  channel        String?  @db.VarChar(100)
  currency       String   @db.Char(3)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  lines SalesLine[]

  @@map("sales")
}

model SalesLine {
  id            Int      @id @default(autoincrement())
  saleId        Int      @map("sale_id")
  inventoryItemId Int    @map("inventory_item_id")
  languageId    Int?     @map("language_id")
  quantity      Int
  unitSalePrice Decimal  @map("unit_sale_price") @db.Decimal(12, 2)
  fees          Decimal  @default(0) @db.Decimal(12, 2)
  shipping      Decimal  @default(0) @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  language      Language?     @relation(fields: [languageId], references: [id])

  @@index([saleId], map: "idx_sales_lines_sale_id")
  @@index([inventoryItemId], map: "idx_sales_lines_inventory")
  @@map("sales_lines")
}
